#!/usr/bin/env ruby

# This script manages selected and installed packages. It can be configured
# with the `~/.config/toolkit` file, which will be autogenerated if it is not
# found when this script is run. An alternate config location can be specified
# with the `TOOLKIT_CONFIG` environment variable.
#
# Author:: Greg Look

require 'optparse'
require 'pathname'

SCRIPT_NAME = File.basename($0)
TOOLKIT_ROOT = Pathname.new(__FILE__).realpath.dirname
PACKAGE_ROOT = TOOLKIT_ROOT + 'packages'

$: << TOOLKIT_ROOT + 'lib'

require 'toolkit'

# set default options
$mount = Pathname.new(ENV['HOME'])
$config_path = Pathname.new(ENV['TOOLKIT_CONFIG'] || (ENV['HOME'] + '/.config/toolkit'))
$colorize = true
$verbose = false

# parse command-line options
options = OptionParser.new do |opts|
  opts.banner = "Usage: #{SCRIPT_NAME} [options] [action] [arguments ...]"
  opts.separator ""
  opts.separator "Options:"
  opts.on('-c', "--config FILE", "Set config file location (default: #{$config_path})") {|file| $config_path = Pathname.new(file) }
  opts.on('-m', "--mount DIR", "Set location to install toolkit to (default: #{$mount})") {|dir| $mount = Pathname.new(dir) }
  opts.on(      "--[no-]colorize", "Display output with ANSI color codes (default: #{$colorize})") {|v| $colorize = v }
  opts.on('-v', "--verbose", "Display additional information") { $verbose = true }
  opts.on('-h', "--help", "Display usage information") { puts opts; exit }
  opts.separator ""
  opts.separator "Actions:"
  opts.separator "    show    - prints information about selected and installed packages (default action)"
  opts.separator "    enable  - selects the named packages for installation"
  opts.separator "    disable - disables installation of the named packages"
  opts.separator "    reset   - resets the named packages' selection state"
  opts.separator "    build   - builds links to the selected package files"
end
options.parse!

# helper method to report failures
def fail(msg, code=1)
  STDERR.puts msg
  exit code
end

# initialize toolkit components
$mount = $mount.realpath.freeze
$config = Toolkit::Config.new($config_path)
$packages = Toolkit.load_packages(PACKAGE_ROOT)

# determine action
$action = ARGV.empty? && 'show' || ARGV.shift.downcase

case $action
when 'debug'
  puts "Active packages:"
  $packages.keys.sort.each do |name|
    puts "* #{name}" if $packages[name].active?
  end
  puts ""
  puts "Enabled packages:"
  $config.selected.keys.sort.each do |name|
    puts "+ #{name}" if $config.selected[name]
  end
  puts ""
  puts "Disabled packages:"
  $config.selected.keys.sort.each do |name|
    puts "- #{name}" if $config.selected[name] == false
  end
  puts ""
  puts "Installed packages:"
  $config.installed.sort.each do |name|
    puts "  #{name}"
  end
  puts ""
  puts "Links:"
  length = $config.links.keys.map{|path| path.length }.max
  $config.links.keys.sort.each do |path|
    puts "%-#{length}s -> %s" % [path, $config.links[path]]
  end

when 'help'
  puts options

when 'show'
  if $verbose
    puts "Toolkit mounted at: #{$mount}"
    puts "Configuration file: #{$config.path}"
    puts "Package set root:   #{PACKAGE_ROOT}"
    puts ""
  end

  if $packages.empty?
    puts "It looks like you don't have any package sets installed!"
    puts "Try cloning some into #{PACKAGE_ROOT}"
  else
    indent = "  "
    $packages.keys.sort.each do |name|
      package = $packages[name]
      name_color = $config.installed?(name) ? :light_cyan : :cyan
      status = if $config.selected?(name)
                 Toolkit::ANSI.colorize('+', :light_green)
               elsif $config.selected?(name) == false
                 Toolkit::ANSI.colorize('-', :light_red)
               elsif package.active?
                 Toolkit::ANSI.colorize('*', :light_yellow)
               else
                 ' '
               end

      puts "#{indent}%s %s" % [status, Toolkit::ANSI.colorize(name, name_color)]
    end
  end

when 'enable', 'disable', 'reset'
  fail "Usage: #{SCRIPT_NAME} #{$action} <package> [package ...]" if ARGV.empty?

  selection_value = case $action
                    when 'enable' then true
                    when 'disable' then false
                    else nil end

  ARGV.each do |name|
    if $packages.include?(name)
      $config.selected[name] = selection_value
      change = selection_value.nil? && "setting cleared" || selection_value && "enabled" || "disabled"
      puts "Package %s %s" % [name, change] if $verbose
    else
      STDERR.puts "No package named '#{name}' found"
    end
  end

  $config.save!

when 'build'
  Toolkit.build! PACKAGE_ROOT, $config, $packages, $mount
  $config.save!

else
  fail "Unknown action '#{$action}', try: show, enable, disable, default, build", 2
end
